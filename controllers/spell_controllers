//import dependencies
const express = require('express')
const Materia = require('../models/materia')

//create Router
const router = express.Router()

//Routes

//create spell
router.all('/:materiaId', (req,res) => {
    if(!req.session.loggedIn) {
        res.sendStatus(401)
        return
    } else {
        const materiaId = req.params.materiaId
        req.body.owner = req.session.userId
        Materia.findById(materiaId)
            .then(materia => {
                if (materia.owner != req.session.userId) {
                    res.sendStatus(401)
                    return
                } else {
                    materia.spells.push(req.body)
                    materia.save()
                    res.sendStatus(201)
                    return
                }
            })
            .catch(err => console.log(err))
    }
})

//delete spell
router.delete('/delete/:materiaId/:spellId', (req,res) => {
    const materiaId = req.params.materiaId
    const spellId = req.params.spellId
    const userId = req.session.userId
    Materia.findById(materiaId)
        .then(materia => {
            const spell = materia.spells.id(spellId)
            console.log(spell, materia)
            if (!req.session.loggedIn || materia.owner != userId) {
                res.sendStatus(401)
                return
            } else {
                spell.remove()
                materia.save()
                res.sendStatus(204)
                return
            }
        })
        .catch(err => console.log(err))
})

//export
module.exports = router